<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chord Progression Grid - Rhythm and Sound</title>
  <style>
    :root {
      --box-size: 113px;
      --box-gap: 28px;
      --columns: 5;
      --color-c: #F44336;
      --color-d: #FF9800;
      --color-e: #FFD600;
      --color-f: #4CAF50;
      --color-g: #17b99a;
      --color-a: #1760af;
      --color-b: #9C27B0;
    }
    body {
      font-family: Arial, sans-serif;
      background: #fff;
      text-align: center;
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }
    .app-container {
      margin: 0 auto;
      padding-top: 20px;
      width: max-content;
      max-width: 100vw;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .top-row,
    .bottom-grid-container {
      width: calc(var(--columns) * var(--box-size) + (var(--columns) - 1) * var(--box-gap));
      max-width: 100vw;
      display: flex;
      flex-direction: row;
      justify-content: flex-start;
    }
    .top-row {
      gap: var(--box-gap);
      margin-bottom: 20px;
      background: rgba(200,200,200,0.03);
    }
    .box-space {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: var(--box-size);
      min-width: var(--box-size);
      background: none;
    }
    .slot-box,
    .bpm-clear-stack {
      width: var(--box-size);
      aspect-ratio: 3/5;
      background: #fff;
      margin-bottom: 5px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      min-width: var(--box-size);
      min-height: calc(var(--box-size) * 5 / 3);
      max-width: var(--box-size);
      position: relative;
      overflow: hidden;
      user-select: none;
      border: none;
      box-shadow: none;
      transition: transform 0.20s cubic-bezier(.7,1.8,.6,1.1);
    }
    .slot-box {
      border: none;
      box-shadow: none;
      padding-top: 7px;
      padding-bottom: 7px;
      transition: transform 0.20s cubic-bezier(.7,1.8,.6,1.1);
    }
    .slot-box.enlarged {
      transform: scale(1.25);
      z-index: 5;
    }
    .bpm-clear-stack {
      border: none; box-shadow: none;
    }
    .bpm-clear-stack-inner { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; }
    .refresh-btn {
      width: 55px;
      height: 55px;
      margin-top: 9px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: #e3f1ff;
      color: #1a6fc2;
      font-size: 2.53em;
      border-radius: 50%;
      box-shadow: 0 2px 7px rgba(0,0,0,0.09);
      transition: background 0.16s, color 0.16s, transform 0.16s;
      cursor: pointer;
    }
    .refresh-btn:hover, .refresh-btn:active, .refresh-btn:focus-visible {
      background: #b9e2ff;
      color: #0b396d;
      transform: rotate(-24deg) scale(1.08);
    }
    .refresh-icon { width: 37px; height: 37px; display: block; }
    .bpm-input-block { width: 80px; margin: 0; display: flex; flex-direction: column; align-items: center; }
    .bpm-input-row { display: flex; align-items: center; justify-content: center; width: 100%; margin-bottom: 2px; }
    input[type="number"].bpm-input::-webkit-inner-spin-button,
    input[type="number"].bpm-input::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"].bpm-input[type=number] { -moz-appearance: textfield; }
    input[type="number"].bpm-input {
      width: 53px;
      font-size: 1.38em;
      border: 1.7px solid #1976d2;
      outline: none;
      text-align: center;
      background: #fafdff;
      margin: 0 2px;
      padding: 2px 0;
      height: 41px;
      box-sizing: border-box;
      appearance: textfield;
      border-radius: 0;
    }
    .bpm-stepper { display: flex; flex-direction: column; margin-left: 5px; user-select: none; height: 41px; justify-content: center; }
    .bpm-arrow {
      width: 23px;
      height: 21px;
      text-align: center;
      font-size: 20.7px;
      border: none;
      background: none;
      color: #1976d2;
      cursor: pointer;
      padding: 0;
      margin: 0;
      user-select: none;
      outline: none;
    }
    .bpm-arrow:active, .bpm-arrow:focus-visible { color: #135ba1; background: #e3eafd; }
    .note-rects { display: flex; flex: 1 1 auto; width: 100%; align-items: center; justify-content: center; min-height: 51px; margin-top: 7px; margin-bottom: 4px; }
    .note-rect {
      flex: 1 1 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.21em;
      font-weight: bold;
      color: #fff;
      height: 100%;
      text-shadow: 0 1px 2px rgba(0,0,0,0.10);
      user-select: none;
      min-width: 0;
      min-height: 39px;
    }
    .note-C { background: #F44336; }
    .note-D { background: #FF9800; }
    .note-E { background: #FFD600;}
    .note-F { background: #4CAF50; }
    .note-G { background: #17b99a; }
    .note-A { background: #1760af; }
    .note-B { background: #9C27B0; }
    .dash-img-slot {
      width: 85px;
      height: 85px;
      display: block;
      margin: 7px auto 0 auto;
      object-fit: contain;
    }
    .chord-select {
      font-size: 1.07em;
      width: 92px;
      min-width: 64px;
      max-width: 103px;
      margin-top: auto;
      margin-bottom: 3.5px;
      padding: 2.3px 2.3px;
      border: 1.7px solid #bbb;
      touch-action: manipulation;
      min-height: 23px;
      max-height: 28px;
      z-index: 10;
      position: relative;
      background: #fff;
      color: #222;
      text-align-last: center;
      box-sizing: border-box;
      display: block;
      align-self: center;
      border-radius: 0;
      transition: background 0.2s, color 0.2s;
    }
    .chord-select.c-selected-c { background: var(--color-c); color: #fff; }
    .chord-select.c-selected-dm { background: var(--color-d); color: #fff; }
    .chord-select.c-selected-em { background: var(--color-e); color: #fff; }
    .chord-select.c-selected-f { background: var(--color-f); color: #fff; }
    .chord-select.c-selected-g { background: var(--color-g); color: #fff; }
    .chord-select.c-selected-am { background: var(--color-a); color: #fff; }
    .chord-select.c-selected-c,
    .chord-select.c-selected-dm,
    .chord-select.c-selected-em,
    .chord-select.c-selected-f,
    .chord-select.c-selected-g,
    .chord-select.c-selected-am {
      border-color: #888;
    }
    .chord-select option { text-align: center; font-size: 1.13em; font-family: Georgia, 'Times New Roman', Times, serif; }
    .chord-select option[value="C"]  { background: #F44336; color: #fff; }
    .chord-select option[value="Dm"] { background: #FF9800; color: #fff; }
    .chord-select option[value="Em"] { background: #FFD600; color: #fff; }
    .chord-select option[value="F"]  { background: #4CAF50; color: #fff; }
    .chord-select option[value="G"]  { background: #17b99a; color: #fff; }
    .chord-select option[value="Am"] { background: #1760af; color: #fff; }
    .chord-select option:checked,
    .chord-select option[selected] {
      filter: none !important;
      background-blend-mode: normal !important;
    }
    .bottom-grid-container {
      margin: 0 auto;
      background: rgba(100,100,100,0.01);
      width: calc(var(--columns) * var(--box-size) + (var(--columns) - 1) * var(--box-gap));
    }
    .bottom-grid {
      display: grid;
      grid-template-columns: repeat(5, var(--box-size));
      grid-template-rows: var(--box-size) calc(var(--box-size) / 2);
      gap: 0;
      width: 100%;
      height: calc(var(--box-size) + var(--box-size) / 2);
      background: rgba(200,200,200,0.01);
    }
    .play-btn-cell {
      grid-row: 1 / span 2;
      grid-column: 1 / 2;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
    }
    .circle-play-btn {
      width: 62px;
      height: 62px;
      border: none;
      background: #1976d2;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.65em;
      box-shadow: 0 2.3px 8px rgba(0,0,0,0.17);
      cursor: pointer;
      transition: background 0.18s, box-shadow 0.18s, transform 0.14s;
      margin-right: 0;
      min-width: 62px;
      min-height: 62px;
      user-select: none;
      border-radius: 50%;
    }
    .circle-play-btn:hover,
    .circle-play-btn:focus-visible {
      background: #135ba1;
      box-shadow: 0 2px 12px rgba(25, 118, 210, 0.18);
      transform: scale(1.06);
    }
    .bottom-picture {
      width: 100%;
      height: 100%;
      aspect-ratio: 1/1;
      background: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25em;
      font-weight: bold;
      color: #aaa;
      border: 2px dashed #ccc;
      margin: 0;
      overflow: hidden;
      box-sizing: border-box;
      object-fit: cover;
      background: rgba(230,230,230,0.22);
      grid-row: 1;
      position: relative;
    }
    .picture-placeholder { font-size: 1.4em; color: #bbb; padding: 0 4px; }
    .bottom-picture-img {
      width: 90%;
      height: 90%;
      object-fit: contain;
      display: block;
      margin: 0 auto;
      position: absolute;
      top: 5%;
      left: 5%;
      pointer-events: none;
      user-select: none;
    }
    .rhythm-box-pair {
      display: flex;
      flex-direction: row;
      justify-content: flex-start;
      align-items: stretch;
      width: 100%;
      height: 100%;
      margin: 0;
      gap: 0;
      grid-row: 2;
      background: none;
    }
    .bottom-rhythm-box {
      background: #e0e0e0;
      border: 2.3px solid #aaa;
      cursor: pointer;
      display: inline-block;
      user-select: none;
      transition: background 0.15s, border-color 0.15s, transform 0.13s cubic-bezier(.8,1.8,.7,1.2);
      position: relative;
      font-size: 1.08em;
      box-sizing: border-box;
      width: 50%;
      height: 100%;
      aspect-ratio: 1/1;
      margin: 0;
      border-radius: 0;
    }
    .bottom-rhythm-box.active { background: #4caf50; border-color: #388e3c; }
    .bottom-rhythm-box-text {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.23em; color: #444; font-weight: bold; pointer-events: none; user-select: none;
      letter-spacing: 0.01em;
    }
    @media (max-width: 900px) {
      :root {
        --box-size: 89.7px;
        --box-gap: 14px;
      }
      .top-row, .bottom-grid-container { width: calc(var(--columns) * var(--box-size) + (var(--columns) - 1) * var(--box-gap)); }
      .box-space, .slot-box, .bpm-clear-stack { width: var(--box-size); min-width: var(--box-size); }
      .slot-box, .bpm-clear-stack { aspect-ratio: 3/5; min-height: calc(var(--box-size) * 5 / 3);}
      .bottom-grid { grid-template-columns: repeat(5, var(--box-size)); grid-template-rows: var(--box-size) calc(var(--box-size) / 2); height: calc(var(--box-size) + var(--box-size) / 2);}
      .circle-play-btn { width: 48px; height: 48px; min-width: 48px; min-height: 48px; font-size: 1.8em; }
      .refresh-btn { width: 43.7px; height: 43.7px; font-size: 2.53em;}
      .bottom-rhythm-box-text { font-size: 1em; }
      .dash-img-slot { width: 60px; height: 60px; }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="top-row" id="top-row">
      <div class="box-space">
        <div class="bpm-clear-stack">
          <div class="bpm-clear-stack-inner">
            <button id="clear" class="refresh-btn" title="Clear All" aria-label="Clear All" tabindex="0">
              <svg class="refresh-icon" viewBox="0 0 24 24">
                <path d="M12 5V2L7 6.5l5 4.5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z" fill="currentColor"/>
              </svg>
            </button>
            <div class="bpm-input-block">
              <div class="bpm-input-row">
                <input type="number" id="bpmInput" class="bpm-input" min="30" max="300" value="90" inputmode="numeric" autocomplete="off" />
                <div class="bpm-stepper">
                  <button type="button" class="bpm-arrow" id="bpmUp" tabindex="0" aria-label="Increment BPM">&#9650;</button>
                  <button type="button" class="bpm-arrow" id="bpmDown" tabindex="0" aria-label="Decrement BPM">&#9660;</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="box-space">
        <div class="slot-box" id="slot0">
          <div class="note-rects"></div>
          <img class="dash-img-slot" src="https://raw.githubusercontent.com/VisualMusicalMinds/Musical-Images/1100d582ac41ba2d0b1794da6dd96026a3869249/Cartoon%20RhythmBox5.svg" alt="Rhythm Box Rest" />
          <select class="chord-select" onchange="setSlotColorAndStyle(0, this)">
            <option value="">-</option>
            <option value="empty"></option>
            <option value="C">C / I</option>
            <option value="Dm">Dm / ii</option>
            <option value="Em">Em / iii</option>
            <option value="F">F / IV</option>
            <option value="G">G / V</option>
            <option value="Am">Am / vi</option>
          </select>
        </div>
      </div>
      <div class="box-space">
        <div class="slot-box" id="slot1">
          <div class="note-rects"></div>
          <img class="dash-img-slot" src="https://raw.githubusercontent.com/VisualMusicalMinds/Musical-Images/1100d582ac41ba2d0b1794da6dd96026a3869249/Cartoon%20RhythmBox5.svg" alt="Rhythm Box Rest" />
          <select class="chord-select" onchange="setSlotColorAndStyle(1, this)">
            <option value="">-</option>
            <option value="empty"></option>
            <option value="C">C / I</option>
            <option value="Dm">Dm / ii</option>
            <option value="Em">Em / iii</option>
            <option value="F">F / IV</option>
            <option value="G">G / V</option>
            <option value="Am">Am / vi</option>
          </select>
        </div>
      </div>
      <div class="box-space">
        <div class="slot-box" id="slot2">
          <div class="note-rects"></div>
          <img class="dash-img-slot" src="https://raw.githubusercontent.com/VisualMusicalMinds/Musical-Images/1100d582ac41ba2d0b1794da6dd96026a3869249/Cartoon%20RhythmBox5.svg" alt="Rhythm Box Rest" />
          <select class="chord-select" onchange="setSlotColorAndStyle(2, this)">
            <option value="">-</option>
            <option value="empty"></option>
            <option value="C">C / I</option>
            <option value="Dm">Dm / ii</option>
            <option value="Em">Em / iii</option>
            <option value="F">F / IV</option>
            <option value="G">G / V</option>
            <option value="Am">Am / vi</option>
          </select>
        </div>
      </div>
      <div class="box-space">
        <div class="slot-box" id="slot3">
          <div class="note-rects"></div>
          <img class="dash-img-slot" src="https://raw.githubusercontent.com/VisualMusicalMinds/Musical-Images/1100d582ac41ba2d0b1794da6dd96026a3869249/Cartoon%20RhythmBox5.svg" alt="Rhythm Box Rest" />
          <select class="chord-select" onchange="setSlotColorAndStyle(3, this)">
            <option value="">-</option>
            <option value="empty"></option>
            <option value="C">C / I</option>
            <option value="Dm">Dm / ii</option>
            <option value="Em">Em / iii</option>
            <option value="F">F / IV</option>
            <option value="G">G / V</option>
            <option value="Am">Am / vi</option>
          </select>
        </div>
      </div>
    </div>
    <div class="bottom-grid-container" id="bottom-grid-container">
      <div class="bottom-grid" id="bottom-grid">
        <div class="play-btn-cell">
          <button id="playPauseBtn" class="circle-play-btn" title="Play" aria-label="Play/Pause" tabindex="0">
            <svg id="playIcon" xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="2 2 20 20" style="display:block;">
              <polygon points="7,5 19,12 7,19" fill="white"/>
            </svg>
            <svg id="pauseIcon" xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="2 2 20 20" style="display:none;">
              <rect x="7" y="5" width="4" height="14" fill="white"/>
              <rect x="15" y="5" width="4" height="14" fill="white"/>
            </svg>
          </button>
        </div>
        <div class="bottom-picture" id="bottomPic0" style="grid-row:1; grid-column:2;">
          <img class="bottom-picture-img" src="https://raw.githubusercontent.com/VisualMusicalMinds/Musical-Images/48e79626ae5b3638784c98a6f73ec0e342cf9894/Cartoon%20RhythmBox1.svg" alt="Rhythm Box" />
        </div>
        <div class="bottom-picture" id="bottomPic1" style="grid-row:1; grid-column:3;">
          <img class="bottom-picture-img" src="https://raw.githubusercontent.com/VisualMusicalMinds/Musical-Images/48e79626ae5b3638784c98a6f73ec0e342cf9894/Cartoon%20RhythmBox1.svg" alt="Rhythm Box" />
        </div>
        <div class="bottom-picture" id="bottomPic2" style="grid-row:1; grid-column:4;">
          <img class="bottom-picture-img" src="https://raw.githubusercontent.com/VisualMusicalMinds/Musical-Images/48e79626ae5b3638784c98a6f73ec0e342cf9894/Cartoon%20RhythmBox1.svg" alt="Rhythm Box" />
        </div>
        <div class="bottom-picture" id="bottomPic3" style="grid-row:1; grid-column:5;">
          <img class="bottom-picture-img" src="https://raw.githubusercontent.com/VisualMusicalMinds/Musical-Images/48e79626ae5b3638784c98a6f73ec0e342cf9894/Cartoon%20RhythmBox1.svg" alt="Rhythm Box" />
        </div>
        <div class="rhythm-box-pair" style="grid-row:2; grid-column:2;">
          <div class="bottom-rhythm-box" data-pair="0" data-which="0"><span class="bottom-rhythm-box-text">1</span></div>
          <div class="bottom-rhythm-box" data-pair="0" data-which="1"><span class="bottom-rhythm-box-text">&amp;</span></div>
        </div>
        <div class="rhythm-box-pair" style="grid-row:2; grid-column:3;">
          <div class="bottom-rhythm-box" data-pair="1" data-which="0"><span class="bottom-rhythm-box-text">2</span></div>
          <div class="bottom-rhythm-box" data-pair="1" data-which="1"><span class="bottom-rhythm-box-text">&amp;</span></div>
        </div>
        <div class="rhythm-box-pair" style="grid-row:2; grid-column:4;">
          <div class="bottom-rhythm-box" data-pair="2" data-which="0"><span class="bottom-rhythm-box-text">3</span></div>
          <div class="bottom-rhythm-box" data-pair="2" data-which="1"><span class="bottom-rhythm-box-text">&amp;</span></div>
        </div>
        <div class="rhythm-box-pair" style="grid-row:2; grid-column:5;">
          <div class="bottom-rhythm-box" data-pair="3" data-which="0"><span class="bottom-rhythm-box-text">4</span></div>
          <div class="bottom-rhythm-box" data-pair="3" data-which="1"><span class="bottom-rhythm-box-text">&amp;</span></div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // --- Sound Synthesis Variables ---
    let ctx = null, masterGain = null;
    async function ensureAudio() {
      if (!ctx) {
        ctx = new (window.AudioContext || window.webkitAudioContext)();
        masterGain = ctx.createGain();
        masterGain.gain.value = 1;
        masterGain.connect(ctx.destination);
      }
      if (ctx.state !== "running") {
        await ctx.resume();
      }
    }
    // ---- BRUSH STROKE ----
    async function playBrush() {
      await ensureAudio();
      const duration = 0.09;
      const bufferSize = ctx.sampleRate * duration;
      const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
      const noise = ctx.createBufferSource();
      noise.buffer = buffer;
      const filter = ctx.createBiquadFilter();
      filter.type = "bandpass";
      filter.frequency.value = 2000;
      filter.Q.value = 1.8;
      const gain = ctx.createGain();
      gain.gain.value = 0.5;
      gain.gain.setValueAtTime(0.5, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
      noise.connect(filter).connect(gain).connect(masterGain);
      noise.start();
      noise.stop(ctx.currentTime + duration);
    }
    // ---- BASS DRUM ----
    async function playBassDrum() {
      await ensureAudio();
      const duration = 0.19;
      const osc = ctx.createOscillator();
      osc.type = "sine";
      osc.frequency.setValueAtTime(140, ctx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(42, ctx.currentTime + duration * 0.85);
      const gain = ctx.createGain();
      gain.gain.setValueAtTime(1, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
      osc.connect(gain).connect(masterGain);
      osc.start();
      osc.stop(ctx.currentTime + duration);
    }

    // --- App logic and UI variables ---
    const chordTones = {
      'C':   ['C', 'E', 'G'],
      'Dm':  ['D', 'F', 'A'],
      'Em':  ['E', 'G', 'A'],
      'F':   ['F', 'A', 'C'],
      'G':   ['G', 'B', 'D'],
      'Am':  ['A', 'C', 'E']
    };
    const noteColorClass = {
      'C': 'note-C',
      'D': 'note-D',
      'E': 'note-E',
      'F': 'note-F',
      'G': 'note-G',
      'A': 'note-A',
      'B': 'note-B'
    };
    // Updated dash image for top slots to the Rest image
    const restDashImgUrl = "https://raw.githubusercontent.com/VisualMusicalMinds/Musical-Images/1100d582ac41ba2d0b1794da6dd96026a3869249/Cartoon%20RhythmBox5.svg";
    // Bottom row "empty" image remains the original
    const dashImgUrl = "https://raw.githubusercontent.com/VisualMusicalMinds/Musical-Images/48e79626ae5b3638784c98a6f73ec0e342cf9894/Cartoon%20RhythmBox1.svg";
    const rhythmBox2 = "https://raw.githubusercontent.com/VisualMusicalMinds/Musical-Images/48e79626ae5b3638784c98a6f73ec0e342cf9894/Cartoon%20RhythmBox2.svg";
    const rhythmBox3 = "https://raw.githubusercontent.com/VisualMusicalMinds/Musical-Images/48e79626ae5b3638784c98a6f73ec0e342cf9894/Cartoon%20RhythmBox3.svg";
    const rhythmBox4 = "https://raw.githubusercontent.com/VisualMusicalMinds/Musical-Images/48e79626ae5b3638784c98a6f73ec0e342cf9894/Cartoon%20RhythmBox4.svg";

    function setSlotColorAndStyle(slotIndex, select) {
      setSlotContent(slotIndex, select.value);
      select.classList.remove(
        'c-selected-c', 'c-selected-dm', 'c-selected-em', 'c-selected-f', 'c-selected-g', 'c-selected-am'
      );
      switch(select.value) {
        case 'C':  select.classList.add('c-selected-c'); break;
        case 'Dm': select.classList.add('c-selected-dm'); break;
        case 'Em': select.classList.add('c-selected-em'); break;
        case 'F':  select.classList.add('c-selected-f'); break;
        case 'G':  select.classList.add('c-selected-g'); break;
        case 'Am': select.classList.add('c-selected-am'); break;
        default: break;
      }
    }

    function setSlotContent(slotIndex, chord) {
      const slot = document.getElementById('slot' + slotIndex);
      const noteRects = slot.querySelector('.note-rects');
      let img = slot.querySelector('.dash-img-slot');
      noteRects.innerHTML = '';
      if (chord === "" /* dash option */) {
        if (!img) {
          img = document.createElement('img');
          img.className = 'dash-img-slot';
          img.src = restDashImgUrl;
          img.alt = "Rhythm Box Rest";
          slot.insertBefore(img, slot.querySelector('.chord-select'));
        } else {
          img.src = restDashImgUrl;
          img.alt = "Rhythm Box Rest";
          img.style.display = "block";
        }
      } else {
        if (img) img.style.display = "none";
      }
      slot.className = 'slot-box';
      if (!chord || chord === "empty" || chord === "") {
        // Don't render notes for empty or dash
        return;
      }
      const tones = chordTones[chord];
      noteRects.innerHTML = tones.map(note =>
        `<div class="note-rect ${noteColorClass[note]}">${note}</div>`
      ).join('');
    }

    // Rhythm picture logic for bottom row
    function updateRhythmPictures() {
      for (let pair = 0; pair < 4; ++pair) {
        // Find the two rhythm boxes for this pair
        const box1 = document.querySelector(`.bottom-rhythm-box[data-pair="${pair}"][data-which="0"]`);
        const box2 = document.querySelector(`.bottom-rhythm-box[data-pair="${pair}"][data-which="1"]`);
        const picDiv = document.getElementById('bottomPic'+pair);
        const img = picDiv.querySelector('.bottom-picture-img');
        let url = dashImgUrl; // Default
        if (box1.classList.contains('active') && !box2.classList.contains('active')) {
          url = rhythmBox2;
        } else if (box1.classList.contains('active') && box2.classList.contains('active')) {
          url = rhythmBox3;
        } else if (!box1.classList.contains('active') && box2.classList.contains('active')) {
          url = rhythmBox4;
        }
        img.src = url;
      }
    }

    // --- Playback Logic ---
    const playPauseBtn = document.getElementById('playPauseBtn');
    const playIcon = document.getElementById('playIcon');
    const pauseIcon = document.getElementById('pauseIcon');
    let isPlaying = false;
    let rhythmInterval = null;
    let slotIds = ['slot0', 'slot1', 'slot2', 'slot3'];

    // For sound sequencing
    let quarterNoteStep = 0; // 0 to 3
    let rhythmStep = 0; // 0 to 7

    function getActiveSlotIndexes() {
      // Only include slots NOT set to "empty" (blank), let "-" (value="") play
      return slotIds.map((id, i) => {
        const select = document.getElementById(id).querySelector('.chord-select');
        return (select.value !== "empty") ? i : null;
      }).filter(i => i !== null);
    }

    // --- Main playback loop ---
    function setPlaying(playing) {
      isPlaying = playing;
      if (isPlaying) {
        playIcon.style.display = "none";
        pauseIcon.style.display = "block";
        playPauseBtn.title = "Pause";
        playPauseBtn.setAttribute('aria-label', 'Pause');
        startMainAnimation();
      } else {
        playIcon.style.display = "block";
        pauseIcon.style.display = "none";
        playPauseBtn.title = "Play";
        playPauseBtn.setAttribute('aria-label', 'Play');
        stopMainAnimation();
      }
    }

    function startMainAnimation() {
      stopMainAnimation();
      quarterNoteStep = 0;
      rhythmStep = 0;
      // Highlight the current slot at startup
      const activeSlots = getActiveSlotIndexes();
      if (activeSlots.length > 0) highlightSlot(activeSlots[quarterNoteStep]);
      // Set up timing
      const bpm = parseInt(document.getElementById('bpmInput').value) || 90;
      const intervalMs = Math.round((60 / bpm) * 1000); // Quarter note in ms

      // Play on first beat immediately
      playQuarterNoteStep();

      rhythmInterval = setInterval(playQuarterNoteStep, intervalMs);
    }

    function stopMainAnimation() {
      if (rhythmInterval) clearInterval(rhythmInterval);
      for (let i = 0; i < slotIds.length; i++) unhighlightSlot(i);
    }

    async function playQuarterNoteStep() {
      // Sound: play brush on every quarter note
      playBrush();

      // Highlight logic
      const activeSlots = getActiveSlotIndexes();
      if (activeSlots.length > 0) {
        for (let i = 0; i < slotIds.length; i++) unhighlightSlot(i);
        highlightSlot(activeSlots[quarterNoteStep % activeSlots.length]);
      }

      // Play bass drum if rhythm box is active for this step
      // Each rhythmStep is 0-7 (pairs: 0,1 / 2,3 / 4,5 / 6,7)
      const pair = Math.floor(rhythmStep / 2);
      const which = rhythmStep % 2;
      const box = document.querySelector(`.bottom-rhythm-box[data-pair="${pair}"][data-which="${which}"]`);
      if (box && box.classList.contains('active')) {
        playBassDrum();
      }

      // Step advance
      quarterNoteStep = (quarterNoteStep + 1) % 4;
      rhythmStep = (rhythmStep + 1) % 8;
    }

    function highlightSlot(idx) {
      document.getElementById(slotIds[idx]).classList.add('enlarged');
    }
    function unhighlightSlot(idx) {
      document.getElementById(slotIds[idx]).classList.remove('enlarged');
    }

    playPauseBtn.addEventListener('click', function() {
      setPlaying(!isPlaying);
    });
    playPauseBtn.addEventListener('touchstart', function(e) {
      e.preventDefault();
      setPlaying(!isPlaying);
    }, {passive: false});
    playPauseBtn.addEventListener('keydown', function(e) {
      if (e.key === " " || e.key === "Enter") {
        e.preventDefault();
        setPlaying(!isPlaying);
      }
    });

    // Rhythm box click/toggle for bottom grid
    document.querySelectorAll('.bottom-rhythm-box').forEach(box => {
      box.addEventListener('click', function(e) {
        box.classList.toggle('active');
        updateRhythmPictures();
      });
      box.addEventListener('touchstart', function(e) {
        e.preventDefault();
        box.classList.toggle('active');
        updateRhythmPictures();
      }, {passive: false});
      box.setAttribute('tabindex', '0');
      box.addEventListener('keydown', function(e) {
        if (e.key === " " || e.key === "Enter") {
          e.preventDefault();
          box.classList.toggle('active');
          updateRhythmPictures();
        }
      });
    });

    // Clear all logic for top slots and rhythm
    function clearAll() {
      for (let i = 0; i < 4; i++) {
        const slot = document.getElementById('slot'+i);
        slot.querySelector('.note-rects').innerHTML = '';
        const select = slot.querySelector('.chord-select');
        select.selectedIndex = 0;
        setSlotColorAndStyle(i, select);
        slot.classList.remove('enlarged');
        let img = slot.querySelector('.dash-img-slot');
        if (img) {
          img.src = restDashImgUrl;
          img.alt = "Rhythm Box Rest";
          img.style.display = "block";
        }
      }
      document.querySelectorAll('.bottom-rhythm-box').forEach(box => box.classList.remove('active'));
      updateRhythmPictures();
      setPlaying(false);
    }
    document.getElementById('clear').addEventListener('click', clearAll);
    document.getElementById('clear').addEventListener('touchstart', function(e) {
      e.preventDefault();
      clearAll();
    }, {passive: false});

    // BPM input logic with hold-to-repeat
    const bpmInput = document.getElementById('bpmInput');
    const bpmUp = document.getElementById('bpmUp');
    const bpmDown = document.getElementById('bpmDown');

    function clampBpm(val) {
      return Math.max(30, Math.min(300, val));
    }
    bpmInput.addEventListener('input', function() {
      let v = parseInt(bpmInput.value || 90);
      if (isNaN(v)) v = 90;
      bpmInput.value = clampBpm(v);
    });
    bpmInput.addEventListener('blur', function() {
      bpmInput.value = clampBpm(parseInt(bpmInput.value || 90));
    });
    bpmInput.addEventListener('keydown', function(e) {
      if (e.key === 'ArrowUp') {
        bpmInput.value = clampBpm(parseInt(bpmInput.value || 90) + 1);
        e.preventDefault();
      } else if (e.key === 'ArrowDown') {
        bpmInput.value = clampBpm(parseInt(bpmInput.value || 90) - 1);
        e.preventDefault();
      }
    });

    // --- Hold-to-repeat logic for bpmUp and bpmDown ---
    let bpmHoldInterval = null;
    let bpmHoldTimeout = null;
    function startHold(dir) {
      // dir: +1 for up, -1 for down
      function step() {
        let v = parseInt(bpmInput.value || 90);
        if (isNaN(v)) v = 90;
        bpmInput.value = clampBpm(v + dir);
        bpmInput.dispatchEvent(new Event('input'));
      }
      step(); // initial step
      bpmHoldTimeout = setTimeout(() => {
        bpmHoldInterval = setInterval(step, 60); // scroll fast
      }, 500); // 500ms delay before auto scroll
    }
    function stopHold() {
      clearTimeout(bpmHoldTimeout);
      clearInterval(bpmHoldInterval);
      bpmHoldTimeout = null;
      bpmHoldInterval = null;
    }
    // Up arrow events
    bpmUp.addEventListener('mousedown', e => { startHold(+1); });
    bpmUp.addEventListener('touchstart', e => { e.preventDefault(); startHold(+1); }, {passive: false});
    bpmUp.addEventListener('mouseup', stopHold);
    bpmUp.addEventListener('mouseleave', stopHold);
    bpmUp.addEventListener('touchend', stopHold);
    bpmUp.addEventListener('touchcancel', stopHold);
    // Down arrow events
    bpmDown.addEventListener('mousedown', e => { startHold(-1); });
    bpmDown.addEventListener('touchstart', e => { e.preventDefault(); startHold(-1); }, {passive: false});
    bpmDown.addEventListener('mouseup', stopHold);
    bpmDown.addEventListener('mouseleave', stopHold);
    bpmDown.addEventListener('touchend', stopHold);
    bpmDown.addEventListener('touchcancel', stopHold);
    // Keyboard - keep old click behavior
    bpmUp.addEventListener('click', function() {
      bpmInput.value = clampBpm(parseInt(bpmInput.value || 90) + 1);
      bpmInput.dispatchEvent(new Event('input'));
    });
    bpmDown.addEventListener('click', function() {
      bpmInput.value = clampBpm(parseInt(bpmInput.value || 90) - 1);
      bpmInput.dispatchEvent(new Event('input'));
    });

    // Initialize color, slot images, rhythm pictures on page load for selects (dashes at start)
    document.querySelectorAll('.chord-select').forEach((select, idx) => {
      setSlotColorAndStyle(idx, select);
    });
    updateRhythmPictures();
    setPlaying(false);
  </script>
</body>
</html>
